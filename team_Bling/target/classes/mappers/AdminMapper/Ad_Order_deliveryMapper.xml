<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="com.project.bling.mapper.adminmapper.ad_order_deliveryMapper">
	<!-- 전체 주문 개수 -->
	<select id="orderCnt" resultType="int" parameterType="PageMaker">
		SELECT count(o.order_idx)
		FROM bg_order o
		LEFT OUTER JOIN bg_delivery d
		ON o.order_idx=d.order_idx
		<if test='kind=="all"'></if>
		<if test='kind!="all"'>WHERE d.deli_stat=#{kind}</if> 
	</select>

	<!-- 전체 주문 리스트(order_idx 내림차순) -->
	<select id="orderList" resultType="CombineVO" parameterType="PageMaker">
		SELECT o.order_idx,
			   count(o.order_idx) AS 'orderCompCnt',
			   DATE_FORMAT(o.rdate,'%Y-%m-%d') AS 'rdate',
			   u.uname,
			   p.pidx,
			   p.pname,
			   substring_index(op.oname,'+',1) AS 'oname',
			   od.quantity,
			   o.tot_price,
			   o.payment,
			   o.order_yn AS 'O_order_yn',
		       d.order_yn AS 'D_order_yn',
			   o.delivery_yn,
		       d.deli_stat,
		       r.ridx,
		       DATEDIFF(sysdate(),d.deli_com) AS 'date_differ'
		FROM bg_product p
		LEFT JOIN bg_option op
		ON p.pidx=op.pidx
		
		LEFT JOIN bg_order_detail od
		ON op.oidx=od.oidx
		
		RIGHT JOIN bg_order o
		ON o.order_idx=od.order_idx
		
		JOIN bg_user u
		ON o.midx=u.midx
		
		LEFT JOIN bg_delivery d
		ON o.order_idx=d.order_idx
		
		LEFT JOIN bg_review r
        ON od.detail_idx=r.detail_idx
		<if test='kind=="all"'></if>
		<if test='kind=="N"'>WHERE d.deli_stat='N'</if>
		<if test='kind=="Y"'>WHERE d.deli_stat='Y'</if>
		<if test='kind=="A"'>WHERE d.deli_stat='A'</if>
		<if test='kind=="B"'>WHERE d.deli_stat='B'</if>
		<if test='kind=="C"'>WHERE d.deli_stat='C'</if>
		GROUP BY o.order_idx
		ORDER BY o.order_idx
		DESC
		LIMIT #{startPost},#{scri.perPageNum}
	</select>

	<!-- 출고버튼(관리자 주문리스트에서 order 테이블의 delivery_yn 컬럼을 Y로 바꾸기 -->
	<update id="prodStat" parameterType="CombineVO">
		UPDATE bg_order o
		LEFT OUTER JOIN bg_delivery d
		ON o.order_idx=d.order_idx
		SET 
		<if test='kind == "N"'>
		 o.order_yn='N',d.order_yn='N',o.delivery_yn='N',d.deli_stat='N',d.send_day = null,d.deli_com = null
		</if>
		<if test='kind == "Y"'>
		 o.order_yn='Y',d.order_yn='Y',o.delivery_yn='N',d.deli_stat='Y',d.send_day = null,d.deli_com = null
		</if>
		<if test='kind == "A"'>
		 o.order_yn='Y',d.order_yn='Y',o.delivery_yn='N',d.deli_stat='A',d.send_day = null,d.deli_com = null
		</if>
		<if test='kind == "B"'>
		 o.order_yn='Y',d.order_yn='Y',o.delivery_yn='Y',d.deli_stat='B',d.send_day = sysdate(),d.deli_com = null
		</if>
		<if test='kind == "C"'>
		 o.order_yn='Y',d.order_yn='Y',o.delivery_yn='Y',d.deli_stat='C',d.send_day = sysdate(),d.deli_com = sysdate()
		</if>
		WHERE o.order_idx=#{order_idx}
	</update>
</mapper>